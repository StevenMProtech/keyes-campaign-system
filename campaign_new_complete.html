<!DOCTYPE html>
<html>
<head>
    <title>New Campaign - The Keyes Company</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f7f3e5;
            padding: 40px 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #004237 0%, #003329 100%);
            color: white;
            padding: 30px 40px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .ai-section {
            background: #fefbf9;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #f5e6dc;
        }
        .ai-section h3 {
            color: #004237;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .ai-section p {
            color: #004237;
            margin-bottom: 16px;
            line-height: 1.6;
            opacity: 0.9;
        }
        .btn-ai {
            background: #004237;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }
        .btn-ai:hover {
            background: #003329;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 66, 55, 0.3);
        }
        .btn-ai:disabled {
            background: #999;
            cursor: not-allowed;
            transform: none;
        }
        .loading-spinner {
            display: none;
            margin-left: 12px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #004237;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .segment-profile {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-top: 16px;
            display: none;
        }
        .segment-profile.show {
            display: block;
        }
        .segment-profile h4 {
            color: #004237;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .segment-profile ul {
            list-style: none;
            padding: 0;
        }
        .segment-profile li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 14px;
        }
        .segment-profile li:last-child {
            border-bottom: none;
        }
        .explanation-panel {
            background: #f7f3e5;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #004237;
            display: none;
        }
        .explanation-panel.show {
            display: block;
        }
        .explanation-panel h4 {
            color: #004237;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .explanation-panel p {
            color: #333;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .form-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }
        .form-section {
            background: #fcf8f3;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            border-left: 4px solid #fcbfa7;
        }
        .form-section h3 {
            color: #004237;
            margin-bottom: 16px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        label {
            display: block;
            color: #004237;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #004237;
        }
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        .option-group {
            background: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid #e0e0e0;
        }
        .option-group label {
            font-size: 13px;
            margin-bottom: 6px;
        }
        .option-group input[type="text"] {
            margin-bottom: 8px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background: #004237;
            color: white;
        }
        .btn-primary:hover {
            background: #003329;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 66, 55, 0.3);
        }
        .btn-cancel {
            background: #e0e0e0;
            color: #666;
        }
        .btn-cancel:hover {
            background: #d0d0d0;
        }
        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                <a href="/campaigns" style="color: white; text-decoration: none; font-size: 24px; opacity: 0.8; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.8'">‚Üê</a>
                <h1>Create New Campaign</h1>
            </div>
            <p style="margin-top: 8px; opacity: 0.9;">Set up a new email campaign for The Keyes Company</p>
        </div>
        
        <div class="ai-section">
            <h3> AI Campaign Generator</h3>
            <p>Select your target audience and add optional instructions. The AI will generate a complete campaign using Harry Dry's 25 copywriting principles.</p>
            
            <div style="margin: 20px 0;">
                <label for="segment" style="display: block; color: #004237; font-weight: 600; margin-bottom: 8px; font-size: 15px;">Target Audience *</label>
                <select id="segment" name="segment" onchange="handleAudienceChange()" style="width: 100%; padding: 12px; border: 2px solid #004237; border-radius: 6px; font-size: 14px; font-family: inherit; background: white; cursor: pointer;">
                    <option value="__create_new__" style="color: #fcbfa7; font-weight: 600;">+ Create New Audience</option>
                    <option disabled></option>
                    <option value="all-cash" {{SELECTED_ALL_CASH}}>All Cash Buyers</option>
                    <option value="absentee-instate" {{SELECTED_ABSENTEE_INSTATE}}>Absentee Owner (In-State)</option>
                    <option value="absentee-outstate" {{SELECTED_ABSENTEE_OUTSTATE}}>Absentee Owner (Out-of-State)</option>
                    <option value="general" {{SELECTED_GENERAL}}>General Past Clients</option>
                    <option value="homes-over-$2,000,000" {{SELECTED_LUXURY}}>Homes Over $2,000,000</option>
                </select>
                <div class="segment-profile" id="segmentProfile"></div>
            </div>
            
            <div style="margin: 20px 0;">
                <label for="customPrompt" style="display: block; color: #004237; font-weight: 600; margin-bottom: 8px; font-size: 15px;">Custom Instructions (Optional)</label>
                <textarea id="customPrompt" placeholder="e.g., 'Focus on downsizing for retirees' or 'Emphasize tax benefits and investment angles' or 'Make it urgent, highlight limited inventory'" style="width: 100%; padding: 12px; border: 2px solid #004237; border-radius: 6px; font-size: 14px; font-family: inherit; min-height: 80px; resize: vertical;"></textarea>
                <p style="font-size: 12px; color: #666; margin-top: 6px; opacity: 0.8;">Add specific instructions to guide the AI. Leave blank for standard generation.</p>
            </div>
            
            <button type="button" class="btn-ai" id="generateBtn" onclick="generateCampaign()">
                 Generate Campaign with AI
            </button>
            <span class="loading-spinner" id="loadingSpinner"></span>
        </div>
        
        <div class="form-container">
            <form method="POST" id="campaignForm">
                <div class="form-group">
                    <label>Campaign Name *</label>
                    <input type="text" name="name" id="name" required placeholder="e.g., Spring 2025 Equity Campaign">
                    <div class="help-text">Internal name for this campaign (AI will suggest one, or enter your own)</div>
                </div>
                
                <input type="hidden" name="segment" id="segmentHidden">
                
                <div class="form-group">
                    <label>Email Subject Line *</label>
                    <input type="text" name="subject" id="subject" required placeholder="e.g., Unlock Your Home's Hidden Wealth">
                </div>
                
                <div class="form-group">
                    <label>Main Headline *</label>
                    <input type="text" name="headline" id="headline" required placeholder="e.g., Your Fresh Start, Starts Here">
                    <div class="help-text">Primary headline shown in the email</div>
                </div>
                
                <div class="form-group">
                    <label>Subheadline *</label>
                    <input type="text" name="subheadline" id="subheadline" required placeholder="e.g., Discover how much equity you could unlock...">
                    <div class="help-text">Supporting text shown below the callout box (will be displayed in bold dark green)</div>
                </div>
                
                <div class="form-group">
                    <label>Body Copy *</label>
                    <textarea name="body_copy" id="body_copy" required placeholder="Enter the main content text for your email campaign..."></textarea>
                    <div class="help-text">Main content text for the email</div>
                </div>
                
                <div class="form-section">
                    <h3>Callout Box</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">The highlighted box that appears before the form (e.g., equity range)</p>
                    
                    <div class="form-group">
                        <label>Callout Title</label>
                        <input type="text" name="callout_title" id="callout_title" placeholder="e.g., Your Home's Estimated Equity Range">
                    </div>
                    
                    <div class="form-group">
                        <label>Callout Main Text</label>
                        <input type="text" name="callout_main_text" id="callout_main_text" placeholder="e.g., $583k$788k">
                        <div class="help-text">Large text in the center (e.g., dollar amount or key figure)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Callout Subtitle</label>
                        <input type="text" name="callout_subtitle" id="callout_subtitle" placeholder="e.g., Ready to unlock this for your family's next chapter?">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Form Questions</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Build your email form with custom questions and options</p>
                    
                    <h4 style="color: #004237; margin-bottom: 12px;">Question 1 (Radio Buttons)</h4>
                    <div class="form-group">
                        <label>Question Text</label>
                        <input type="text" name="q1_text" id="q1_text" placeholder="e.g., What's next for you?">
                    </div>
                    <div class="form-group">
                        <label>Subtitle (optional)</label>
                        <input type="text" name="q1_subtitle" id="q1_subtitle" placeholder="e.g., Pick what fits  we'll send you a plan">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 1 Label</label>
                        <input type="text" name="q1_opt1_label" id="q1_opt1_label" placeholder="e.g., Buy my next home before selling">
                        <label>Description</label>
                        <input type="text" name="q1_opt1_desc" id="q1_opt1_desc" placeholder="Brief description">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 2 Label</label>
                        <input type="text" name="q1_opt2_label" id="q1_opt2_label" placeholder="e.g., Sell and move on">
                        <label>Description</label>
                        <input type="text" name="q1_opt2_desc" id="q1_opt2_desc" placeholder="Brief description">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 3 Label</label>
                        <input type="text" name="q1_opt3_label" id="q1_opt3_label" placeholder="e.g., Downsize">
                        <label>Description</label>
                        <input type="text" name="q1_opt3_desc" id="q1_opt3_desc" placeholder="Brief description">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 4 Label</label>
                        <input type="text" name="q1_opt4_label" id="q1_opt4_label" placeholder="e.g., Something else">
                        <label>Description</label>
                        <input type="text" name="q1_opt4_desc" id="q1_opt4_desc" placeholder="Brief description">
                    </div>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    
                    <h4 style="color: #004237; margin-bottom: 12px;">Question 2 (Checkboxes)</h4>
                    <div class="form-group">
                        <label>Question Text</label>
                        <input type="text" name="q2_text" id="q2_text" placeholder="e.g., What matters most to you?">
                    </div>
                    <div class="form-group">
                        <label>Subtitle (optional)</label>
                        <input type="text" name="q2_subtitle" id="q2_subtitle" placeholder="e.g., Check all that apply">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 1</label>
                        <input type="text" name="q2_opt1" id="q2_opt1" placeholder="e.g., Getting top dollar">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 2</label>
                        <input type="text" name="q2_opt2" id="q2_opt2" placeholder="e.g., Selling quickly">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 3</label>
                        <input type="text" name="q2_opt3" id="q2_opt3" placeholder="e.g., Minimizing hassle">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 4</label>
                        <input type="text" name="q2_opt4" id="q2_opt4" placeholder="e.g., Privacy and discretion">
                    </div>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    
                    <div style="display: none;">
                    <h4 style="color: #004237; margin-bottom: 12px;">Question 3 (Radio Buttons)</h4>
                    <div class="form-group">
                        <label>Question Text</label>
                        <input type="text" name="q3_text" id="q3_text" placeholder="e.g., When are you thinking about this?">
                    </div>
                    <div class="form-group">
                        <label>Subtitle (optional)</label>
                        <input type="text" name="q3_subtitle" id="q3_subtitle" placeholder="e.g., No pressure  just helps us help you">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 1</label>
                        <input type="text" name="q3_opt1" id="q3_opt1" placeholder="e.g., Ready now">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 2</label>
                        <input type="text" name="q3_opt2" id="q3_opt2" placeholder="e.g., Next 3-6 months">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 3</label>
                        <input type="text" name="q3_opt3" id="q3_opt3" placeholder="e.g., Just exploring">
                    </div>
                    
                    <div class="option-group">
                        <label>Option 4</label>
                        <input type="text" name="q3_opt4" id="q3_opt4" placeholder="e.g., Not sure yet">
                    </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Enhanced CTA Section</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 16px;">Personal, reassuring call-to-action that appears after form questions</p>
                    
                    <div class="form-group">
                        <label>Agent Message *</label>
                        <input type="text" name="cta_agent_message" id="cta_agent_message" required placeholder="e.g., We'll create your custom equity plan in 24 hours">
                        <div class="help-text">Personal message from the agent/team (will be shown twice - in checkbox and below photo)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>CTA Tagline *</label>
                        <input type="text" name="cta_tagline" id="cta_tagline" required placeholder="e.g., No sales pitch, just expert guidance">
                        <div class="help-text">Italic tagline that removes friction (shown below agent photo)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>CTA Button Text *</label>
                        <input type="text" name="cta_button_text" id="cta_button_text" required value="GET MY EQUITY PLAN">
                        <div class="help-text">Large button text (will be displayed in all caps)</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Agent Photo URL</label>
                        <input type="url" name="cta_agent_photo" id="cta_agent_photo" placeholder="e.g., https://example.com/agent-photo.jpg">
                        <div class="help-text">URL to agent photo (leave blank for default). Image should be square, at least 200x200px.</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Campaign Status</label>
                    <select name="status">
                        <option value="draft">Draft</option>
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">Create Campaign</button>
                    <a href="/campaigns" class="btn btn-cancel">Cancel</a>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Pre-select audience from URL parameter on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const segmentParam = urlParams.get('segment') || urlParams.get('audience');
            
            if (segmentParam) {
                const segmentSelect = document.getElementById('segment');
                if (segmentSelect) {
                    segmentSelect.value = segmentParam;
                    // Load the profile for this segment
                    updateSegmentProfile();
                }
            }
        });
        
        // Handle audience dropdown change
        function handleAudienceChange() {
            const segmentId = document.getElementById('segment').value;
            
            // If user selects "Create New Audience", redirect to audience builder
            if (segmentId === '__create_new__') {
                window.location.href = '/audiences/new';
                return;
            }
            
            // Otherwise, update segment profile
            updateSegmentProfile();
        }
        
        // Update segment profile when segment changes
        function updateSegmentProfile() {
            const segmentId = document.getElementById('segment').value;
            const profileDiv = document.getElementById('segmentProfile');
            
            fetch(`/api/segment-profile/${segmentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        profileDiv.classList.remove('show');
                        return;
                    }
                    
                    let html = `
                        <h4>${data.name}</h4>
                        <ul>
                            <li><strong>Demographics:</strong> ${data.demographics}</li>
                            <li><strong>Psychographics:</strong> ${data.psychographics}</li>
                            <li><strong>Communication Style:</strong> ${data.communication_style}</li>
                        </ul>
                    `;
                    
                    profileDiv.innerHTML = html;
                    profileDiv.classList.add('show');
                })
                .catch(error => {
                    console.error('Error fetching segment profile:', error);
                    profileDiv.classList.remove('show');
                });
        }
        
        // Generate campaign with AI
        function generateCampaign() {
            const segmentId = document.getElementById('segment').value;
            const campaignName = document.getElementById('name').value || 'New Campaign';
            const generateBtn = document.getElementById('generateBtn');
            const spinner = document.getElementById('loadingSpinner');
            
            // Show loading state
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            spinner.style.display = 'inline-block';
            
            // Get custom prompt
            const customPrompt = document.getElementById('customPrompt').value.trim();
            
            fetch('/api/generate-campaign', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    segment_id: segmentId,
                    campaign_name: campaignName,
                    custom_prompt: customPrompt
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error generating campaign: ' + data.error);
                    return;
                }
                
                // Fill in campaign name (AI generated)
                if (data.campaign_name) {
                    document.getElementById('name').value = data.campaign_name;
                }
                
                // Sync segment to hidden field
                document.getElementById('segmentHidden').value = segmentId;
                
                // Fill in basic fields
                document.getElementById('subject').value = data.subject_line || '';
                document.getElementById('headline').value = data.headline || '';
                document.getElementById('subheadline').value = data.subheadline || '';
                document.getElementById('body_copy').value = data.body_copy || '';
                document.getElementById('cta_agent_message').value = data.cta_agent_message || '';
                document.getElementById('cta_tagline').value = data.cta_tagline || '';
                document.getElementById('cta_button_text').value = data.cta_button_text || 'GET MY EQUITY PLAN';
                
                // Fill in callout box
                if (data.callout_box) {
                    document.getElementById('callout_title').value = data.callout_box.title || '';
                    document.getElementById('callout_main_text').value = data.callout_box.main_text || '';
                    document.getElementById('callout_subtitle').value = data.callout_box.subtitle || '';
                }
                
                // Fill in form questions
                if (data.form_questions && data.form_questions.length >= 3) {
                    // Question 1
                    const q1 = data.form_questions[0];
                    document.getElementById('q1_text').value = q1.question || '';
                    document.getElementById('q1_subtitle').value = q1.subtitle || '';
                    if (q1.options && q1.options.length >= 4) {
                        document.getElementById('q1_opt1_label').value = q1.options[0].label || '';
                        document.getElementById('q1_opt1_desc').value = q1.options[0].description || '';
                        document.getElementById('q1_opt2_label').value = q1.options[1].label || '';
                        document.getElementById('q1_opt2_desc').value = q1.options[1].description || '';
                        document.getElementById('q1_opt3_label').value = q1.options[2].label || '';
                        document.getElementById('q1_opt3_desc').value = q1.options[2].description || '';
                        document.getElementById('q1_opt4_label').value = q1.options[3].label || '';
                        document.getElementById('q1_opt4_desc').value = q1.options[3].description || '';
                    }
                    
                    // Question 2
                    const q2 = data.form_questions[1];
                    document.getElementById('q2_text').value = q2.question || '';
                    document.getElementById('q2_subtitle').value = q2.subtitle || '';
                    if (q2.options && q2.options.length >= 4) {
                        document.getElementById('q2_opt1').value = q2.options[0].label || '';
                        document.getElementById('q2_opt2').value = q2.options[1].label || '';
                        document.getElementById('q2_opt3').value = q2.options[2].label || '';
                        document.getElementById('q2_opt4').value = q2.options[3].label || '';
                    }
                    
                    // Question 3
                    const q3 = data.form_questions[2];
                    document.getElementById('q3_text').value = q3.question || '';
                    document.getElementById('q3_subtitle').value = q3.subtitle || '';
                    if (q3.options && q3.options.length >= 4) {
                        document.getElementById('q3_opt1').value = q3.options[0].label || '';
                        document.getElementById('q3_opt2').value = q3.options[1].label || '';
                        document.getElementById('q3_opt3').value = q3.options[2].label || '';
                        document.getElementById('q3_opt4').value = q3.options[3].label || '';
                    }
                }
                
                // Scroll to form
                document.getElementById('campaignForm').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating campaign. Please try again.');
            })
            .finally(() => {
                // Reset button state
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Campaign with AI';
                spinner.style.display = 'none';
            });
        }
        
        // Load segment profile on page load
        window.addEventListener('DOMContentLoaded', updateSegmentProfile);
    </script>
</body>
</html>
